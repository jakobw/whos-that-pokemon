<!DOCTYPE html>
<html>
<head>
  <title>Pokemon raten</title>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <style type="text/css">
    #poke-image {
      height: 350px;
      width: 350px;
    }
    #guess input, #submit-score input {
      margin-bottom: 0;
    }
    #time, #missing {
      font-weight: bold;
    }
    .data {
      font-size: 20px;
    }
    #success {
      margin-top: 20px;
    }
    #poke-slide {
      height: 150px;
      overflow: hidden;
    }
    #poke-slide img {
      height: 150px;
    }
  </style>
  <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript">
    var pokemon = ['bisasam', 'bisaknosp', 'bisaflor', 'glumanda', 'glutexo', 'glurak', 'schiggy', 'schillok', 'turtok', 'raupy', 'safcon', 'smettbo', 'hornliu', 'kokuna', 'bibor', 'taubsi', 'tauboga', 'tauboss', 'rattfratz', 'rattikarl', 'habitak', 'ibitak', 'rettan', 'arbok', 'pikachu', 'raichu', 'sandan', 'sandamer', 'nidoran w', 'nidorina', 'nidoqueen', 'nidoran m', 'nidorino', 'nidoking', 'piepi', 'pixi', 'vulpix', 'vulnona', 'pummeluff', 'knuddeluff', 'zubat', 'golbat', 'myrapla', 'duflor', 'giflor', 'paras', 'parasek', 'bluzuk', 'omot', 'digda', 'digdri', 'mauzi', 'snobilikat', 'enton', 'entoron', 'menki', 'rasaff', 'fukano', 'arkani', 'quapsel', 'quaputzi', 'quappo', 'abra', 'kadabra', 'simsala', 'machollo', 'maschock', 'machomei', 'knofensa', 'ultrigaria', 'sarzenia', 'tentacha', 'tentoxa', 'kleinstein', 'georok', 'geowaz', 'ponita', 'gallopa', 'flegmon', 'lahmus', 'magnetilo', 'magneton', 'porenta', 'dodu', 'dodri', 'jurob', 'jugong', 'sleima', 'sleimok', 'muschas', 'austos', 'nebulak', 'alpollo', 'gengar', 'onix', 'traumato', 'hypno', 'krabby', 'kingler', 'voltobal', 'lektrobal', 'owei', 'kokowei', 'tragosso', 'knogga', 'kicklee', 'nockchan', 'schlurp', 'smogon', 'smogmog', 'rihorn', 'rizeros', 'chaneira', 'tangela', 'kangama', 'seeper', 'seemon', 'goldini', 'golking', 'sterndu', 'starmie', 'pantimos', 'sichlor', 'rossana', 'elektek', 'magmar', 'pinsir', 'tauros', 'karpador', 'garados', 'lapras', 'ditto', 'evoli', 'aquana', 'blitza', 'flamara', 'porygon', 'amonitas', 'amoroso', 'kabuto', 'kabutops', 'aerodactyl', 'relaxo', 'arktos', 'zapdos', 'lavados', 'dratini', 'dragonir', 'dragoran', 'mewtu', 'mew'],
      missing = [],
      current = -1,
      timer = 0;

    for (var i = 1; i <= 151; i++) missing.push(i);

    var showPkmn = function () {
      current = Math.floor(Math.random() * missing.length);
      loadPkmn(current);
    };

    var loadPkmn = function (nr) {
      var img = new Image(),
          canvas = document.getElementById('poke-image').getContext('2d');

      canvas.clearRect(0, 0, 350, 350);

      img.onload = function () {
        canvas.drawImage(img, 0, 0);
        var imageData = canvas.getImageData(0, 0, img.width, img.height);

        for (var i = 0; i < imageData.data.length; i += 4) {
          if (imageData.data[i+3] > 100) {
            imageData.data[i] = 10;
            imageData.data[i+1] = 10;
            imageData.data[i+2] = 10;
            imageData.data[i+3] = 255;
          }
        }
        canvas.putImageData(imageData, 0, 0);
      };
      img.src = 'images/' + missing[nr] + '.png';
    };

    var removeMissing = function () {
      missing.splice(current, 1);
    };

    var success = function () {
      clearInterval(1);
      $('#success').show('fast');
      $('#final-time').text(timer);
    }

    var updateCounter = function () {
      $('#missing').text(missing.length)
    };

    var showCorrect = function () {
      $('#poke-slide').prepend('<img src="images/' + (missing[current]) + '.png" />');
    };

    var checkGuess = function ($input) {
      if ($input.val().toLowerCase() === pokemon[missing[current] - 1]) {
        showCorrect();
        removeMissing();
        updateCounter();

        if (missing.length > 0) {
          showPkmn();
        } else {
          success();
        }
      }
      $input.val('');
    };

    var initTimer = function () {
      setInterval(function () {
        $('#time').text(++timer);
      }, 1000);
    };

    var showScores = function () {
      $.getJSON('scores.json', function (scores) {
        $.each(scores.sort(function (a, b) {
          return a.Value - b.Value;
        }), function(_, score) {
          $('#scores').append('<li>' + score.Value + ': ' + score.Name + '</li>');
        });
      });
    };

    $(function () {
      showPkmn();

      $('#guess').submit(function(e) {
        checkGuess($(this).find('input'));

        e.preventDefault();
      });

      $('#skip').click(function(e) {
        showPkmn();

        e.preventDefault();
      });

      $('#submit-score').submit(function(e) {
        $.post('score', { name: $('#name').val(), score: timer });
        $('#success').hide();

        e.preventDefault();
      });

      initTimer();
      showScores();
    });
  </script>
</head>
<body>
  <div class="container">
    <div id="success" class="hide alert alert-success">
      <button type="button" class="close" data-dismiss="alert">&times;</button>
      <h4>Yay! Geschafft!</h4>
      <p>
        Du hast alle 151 Pokemon in <span id="final-time"></span> Sekunden erraten!
        <form id="submit-score">
          <input type="text" id="name" placeholder="Dein Name" />
          <button type="submit" class="btn btn-success">Score abschicken</button>
        </form>
      </p>
    </div>
    <div class="row">
      <div class="span6">
        <h1>Welches Pokemon ist das?</h1>
        <form id="guess">
          <input type="text" autofocus="autofocus" />
          <button type="submit" class="btn btn-primary">OK</button>
        </form>
        <p class="data">
          Zeit: <span id="time">0</span><br>
          <span id="missing">151</span> fehlen noch
        </p>
      </div>
      <div class="span4">
        <canvas id="poke-image" height="350" width="350"></canvas>
        <a id="skip" href="#">&Uuml;berspringen &raquo;</a>
      </div>
    </div>
    <div class="row" id="poke-slide"></div>

    <h2>Highscores</h2>
    <ol id="scores"></ol>
  </div>
</body>
</html>
